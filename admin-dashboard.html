<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>License Keys Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #2a5298;
            margin-bottom: 10px;
            font-size: 2em;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .stat-card p {
            opacity: 0.9;
            font-size: 0.9em;
        }
        .search-box {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }
        .search-box input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
        }
        .search-box button {
            padding: 15px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        .search-box button:hover {
            background: #5568d3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #f5f5f5;
            color: #333;
            font-weight: 600;
        }
        tr:hover {
            background: #f9f9f9;
        }
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .badge-success {
            background: #10b981;
            color: white;
        }
        .badge-info {
            background: #3b82f6;
            color: white;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .empty {
            text-align: center;
            padding: 60px;
            color: #999;
        }
        .refresh-btn {
            float: right;
            padding: 10px 20px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .key-info {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîë License Keys Dashboard</h1>
        <p style="color: #666; margin-bottom: 20px;">Qu·∫£n l√Ω v√† theo d√µi license keys ƒë√£ k√≠ch ho·∫°t</p>
        
        <button class="refresh-btn" onclick="loadKeys()">üîÑ Refresh</button>
        
        <div class="stats">
            <div class="stat-card">
                <h3 id="totalKeys">0</h3>
                <p>Keys ƒë√£ k√≠ch ho·∫°t</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <h3 id="totalDevices">0</h3>
                <p>Thi·∫øt b·ªã ƒë√£ ƒëƒÉng k√Ω</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <h3 id="totalUses">0</h3>
                <p>T·ªïng l∆∞·ª£t s·ª≠ d·ª•ng</p>
            </div>
        </div>

        <div class="search-box">
            <input type="text" id="searchKey" placeholder="T√¨m ki·∫øm license key: XXXX-XXXX-XXXX-XXXX">
            <button onclick="searchKey()">üîç T√¨m ki·∫øm</button>
            <button onclick="loadKeys()" style="background: #10b981;">üìã T·∫•t c·∫£</button>
        </div>

        <div id="searchResult"></div>

        <div id="loading" class="loading">
            <p>‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>

        <div id="keysTable"></div>
    </div>

    <script>
        const API_ENDPOINT = 'https://miniznew.giongaysau.workers.dev';
        const KV_NAMESPACE = 'b6a474cb11024056a1ced5c8a9380f39';

        async function loadKeys() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('keysTable').innerHTML = '';
            document.getElementById('searchResult').innerHTML = '';

            try {
                // Note: C·∫ßn t·∫°o endpoint /api/admin/list-keys trong worker ƒë·ªÉ l·∫•y data
                // Hi·ªán t·∫°i s·ª≠ d·ª•ng wrangler CLI ƒë·ªÉ l·∫•y
                
                const response = await fetch(`${API_ENDPOINT}/api/admin/list-keys`, {
                    headers: {
                        'X-Admin-Token': 'your-admin-token-here' // C·∫ßn implement authentication
                    }
                });

                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi API. Vui l√≤ng d√πng wrangler CLI.');
                }

                const keys = await response.json();
                displayKeys(keys);
            } catch (error) {
                document.getElementById('loading').innerHTML = `
                    <div class="empty">
                        <h3>‚ö†Ô∏è Ch∆∞a c√≥ API endpoint</h3>
                        <p>ƒê·ªÉ xem keys ƒë√£ s·ª≠ d·ª•ng, ch·∫°y l·ªánh:</p>
                        <code style="background: #f5f5f5; padding: 10px; display: block; margin: 10px 0;">
                            wrangler kv key list --namespace-id=${KV_NAMESPACE}
                        </code>
                        <p>Ho·∫∑c d√πng script: <strong>check-used-keys.bat</strong></p>
                    </div>
                `;
            }
        }

        async function searchKey() {
            const key = document.getElementById('searchKey').value.trim().toUpperCase();
            if (!key) return;

            document.getElementById('searchResult').innerHTML = '<p class="loading">üîç ƒêang t√¨m...</p>';

            try {
                const response = await fetch(`${API_ENDPOINT}/api/admin/get-key/${key}`, {
                    headers: {
                        'X-Admin-Token': 'your-admin-token-here'
                    }
                });

                if (!response.ok) {
                    throw new Error('Key kh√¥ng t·ªìn t·∫°i ho·∫∑c ch∆∞a k√≠ch ho·∫°t');
                }

                const data = await response.json();
                displayKeyInfo(key, data);
            } catch (error) {
                document.getElementById('searchResult').innerHTML = `
                    <div class="key-info" style="border-color: #10b981; background: #f0fdf4;">
                        <h3>‚ú® Key H·ª£p L·ªá - Ch∆∞a ƒê∆∞·ª£c S·ª≠ D·ª•ng</h3>
                        <p style="color: #15803d; font-weight: 600; margin: 10px 0;">
                            üîë ${key}
                        </p>
                        <table style="margin-top: 15px;">
                            <tr>
                                <td><strong>‚ö° Tr·∫°ng th√°i:</strong></td>
                                <td><span class="badge" style="background: #10b981;">M·ªöI - CH∆ØA K√çCH HO·∫†T</span></td>
                            </tr>
                            <tr>
                                <td><strong>üì± MAC Address:</strong></td>
                                <td><em style="color: #666;">Ch∆∞a bind thi·∫øt b·ªã n√†o</em></td>
                            </tr>
                            <tr>
                                <td><strong>üî¢ S·ªë l·∫ßn s·ª≠ d·ª•ng:</strong></td>
                                <td>0 l·∫ßn</td>
                            </tr>
                        </table>
                        <p style="margin-top: 15px; padding: 10px; background: #dbeafe; border-radius: 8px; color: #1e40af;">
                            üí° Key n√†y c√≥ s·∫µn v√† s·∫µn s√†ng s·ª≠ d·ª•ng. Khi ng∆∞·ªùi d√πng k√≠ch ho·∫°t l·∫ßn ƒë·∫ßu, 
                            key s·∫Ω ƒë∆∞·ª£c bind v·ªõi MAC address c·ªßa thi·∫øt b·ªã ƒë√≥.
                        </p>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #666;">Ki·ªÉm tra th·ªß c√¥ng qua CLI</summary>
                            <code style="background: #fff; padding: 10px; display: block; margin: 10px 0;">
                                wrangler kv key get "${key}" --namespace-id=${KV_NAMESPACE}
                            </code>
                        </details>
                    </div>
                `;
            }
        }

        function displayKeyInfo(key, data) {
            const html = `
                <div class="key-info">
                    <h3>‚úÖ Key H·ª£p L·ªá - ƒê√£ ƒê∆∞·ª£c S·ª≠ D·ª•ng</h3>
                    <p style="color: #10b981; font-weight: 600; margin: 10px 0;">
                        üîë ${key}
                    </p>
                    <table style="margin-top: 15px;">
                        <tr>
                            <td><strong>üì± MAC Address ƒë√£ bind:</strong></td>
                            <td><code style="background: #f0f9ff; padding: 5px 10px; border-radius: 5px;">${data.mac}</code></td>
                        </tr>
                        <tr>
                            <td><strong>üî¢ S·ªë l·∫ßn ƒë√£ s·ª≠ d·ª•ng:</strong></td>
                            <td><span class="badge badge-info">${data.useCount} l·∫ßn</span></td>
                        </tr>
                        <tr>
                            <td><strong>üìÖ K√≠ch ho·∫°t l·∫ßn ƒë·∫ßu:</strong></td>
                           style="color: #666; margin: 15px 0;">
                            H·ªá th·ªëng c√≥ <strong>100 license keys</strong> s·∫µn s√†ng s·ª≠ d·ª•ng.
                        </p>
                        <p style="color: #666;">
                            Khi ng∆∞·ªùi d√πng k√≠ch ho·∫°t license l·∫ßn ƒë·∫ßu, th√¥ng tin s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.
                        </p>
                        <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 10px; text-align: left;">
                            <strong>üí° Th√¥ng tin s·∫Ω bao g·ªìm:</strong>
                            <ul style="margin: 10px 0 0 20px; color: #666;">
                                <li>License key ƒë√£ k√≠ch ho·∫°t</li>
                                <li>MAC address thi·∫øt b·ªã ƒë√£ bind</li>
                                <li>S·ªë l·∫ßn s·ª≠ d·ª•ng</li>
                                <li>Th·ªùi gian k√≠ch ho·∫°t l·∫ßn ƒë·∫ßu</li>
                            </ul>
                        </div
                        </tr>
                        <tr>
                            <td><strong>‚ö° Tr·∫°ng th√°i:</strong></td>
                            <td><span class="badge badge-success">ƒêANG HO·∫†T ƒê·ªòNG</span></td>
                        </tr>
                    </table>
                    <p style="margin-top: 15px; padding: 10px; background: #fffbeb; border-radius: 8px; color: #92400e;">
                        ‚ö†Ô∏è Key n√†y ƒë√£ ƒë∆∞·ª£c bind v·ªõi thi·∫øt b·ªã c√≥ MAC <strong>${data.mac}</strong>. 
                        Ch·ªâ thi·∫øt b·ªã n√†y m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng key.
                    </p>
                </div>
            `;
            document.getElementById('searchResult').innerHTML = html;
        }

        function displayKeys(keys) {
            document.getElementById('loading').style.display = 'none';
            
            if (keys.length === 0) {
                document.getElementById('keysTable').innerHTML = `
                    <div class="empty">
                 h3 style="color: #2a5298; margin: 20px 0 10px 0;">üìä Danh S√°ch Keys ƒê√£ ƒê∆∞·ª£c S·ª≠ D·ª•ng</h3>
                <table>
                    <thead>
                        <tr>
                            <th>üîë License Key</th>
                            <th>üì± MAC Address (ƒê√£ Bind)</th>
                            <th>üî¢ S·ªë L·∫ßn ƒê√£ D√πng</th>
                            <th>üìÖ K√≠ch Ho·∫°t L√∫c</th>
                            <th>‚ö° Tr·∫°ng Th√°i
            // Update stats
            document.getElementById('totalKeys').textContent = keys.length;
            document.getElementById('totalDevices').textContent = new Set(keys.map(k => k.mac)).size;
            document.getElementById('totalUses').textContent = keys.reduce((sum, k) => sum + k.useCount, 0);

            // Display table
            let html = ` style="color: #2a5298;">${item.key}</strong></td>
                        <td><code style="background: #f0f9ff; padding: 5px 10px; border-radius: 5px;">${item.mac}</code></td>
                        <td><span class="badge badge-info">${item.useCount} l·∫ßn</span></td>
                        <td>${new Date(item.firstUsed).toLocaleString('vi-VN')}</td>
                        <td><span class="badge badge-success">ƒêANG D√ôNG</span>
                            <th>License Key</th>
                            <th>MAC Address</th>
                            <th>S·ªë l·∫ßn d√πng</th>
                            <th>K√≠ch ho·∫°t l√∫c</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            keys.forEach(item => {
                html += `
                    <tr>
                        <td><strong>${item.key}</strong></td>
                        <td><code>${item.mac}</code></td>
                        <td><span class="badge badge-success">${item.useCount}</span></td>
                        <td>${new Date(item.firstUsed).toLocaleString('vi-VN')}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('keysTable').innerHTML = html;
        }

        // Load on page load
        loadKeys();
    </script>
</body>
</html>
